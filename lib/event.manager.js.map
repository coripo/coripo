{"version":3,"sources":["../src/event.manager.js"],"names":["GregorianAdapter","require","Event","OneDate","i18next","BasicGenerator","Generator","locales","EventManager","config","init","lng","locale","fallbackLng","initImmediate","resources","trl","key","store","data","t","primaryAdapterId","primaryAdapter","adapters","generators","eventStore","getAdaptersInfo","map","id","a","name","description","getGeneratorsInfo","g","inputs","concat","title","fields","label","type","optional","getAdapter","adapterId","adapter","find","Error","generateDate","dateConfig","helper","getCurrentDate","date","l10n","year","Date","getFullYear","month","getMonth","day","getDate","getMonthInfo","getMonthName","days","getMonthLength","getGenerator","generatorId","generator","construct","plugins","Adapter","dependencies","addEvent","eventConfig","event","generate","removeEvent","eventId","filter","evt","editEvent","handleOverlaps","seriesArray","_since","_till","reduce","sArray","series","overlap","external","includes","conflicts","s","sameGenerator","sameOverlapRule","sort","b","range","since","int","length","master","items","forever","rangeSince","rangeTill","offsetYear","till","slaves","slice","sa","item","events","e","collides","slaveEvents","evts","trimmedSlaves","slave","collision","Object","assign","offsetDay","query","getEventsIn","acc","exports"],"mappings":"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","file":"event.manager.js","sourcesContent":["const GregorianAdapter = require('coripo-core').GregorianAdapter;\nconst Event = require('coripo-core').Event;\nconst OneDate = require('coripo-core').OneDate;\nconst i18next = require('i18next');\nconst BasicGenerator = require('./basic.generator.js').Generator;\nconst locales = require('../locales/index.js');\n\nconst EventManager = function EventManager(config = {}) {\n  i18next.init({\n    lng: config.locale || 'en',\n    fallbackLng: 'en',\n    initImmediate: false,\n    resources: locales,\n  });\n  const trl = (key) => {\n    i18next.store.data = locales;\n    return i18next.t(key);\n  };\n  let primaryAdapterId;\n  let primaryAdapter;\n  let adapters = [];\n  let generators = [];\n  let eventStore = [];\n\n  const getAdaptersInfo = () => adapters.map(a => (\n    { id: a.id, name: a.name, description: a.description }\n  ));\n\n  const getGeneratorsInfo = () => generators.map(g => (\n    {\n      id: g.id,\n      name: g.name,\n      description: g.description,\n      inputs: g.inputs.concat([\n        {\n          title: trl('event-manager.common-generator.field-group.organization.title'),\n          fields: [\n            {\n              id: 'categoryId',\n              label: trl('event-manager.common-generator.field-group.organization.field.category-id.label'),\n              type: 'category',\n              optional: true,\n            },\n            {\n              id: 'tags',\n              label: trl('event-manager.common-generator.field-group.organization.field.tags.label'),\n              type: 'tags',\n              optional: true,\n            },\n          ],\n        },\n      ]),\n    }\n  ));\n\n  const getAdapter = (adapterId) => {\n    const adapter = adapters.find(a => a.id === (adapterId || primaryAdapterId));\n    if (!adapter) throw new Error(`requested adapter '${adapterId}' not found.`);\n    return adapter;\n  };\n\n  const generateDate = (dateConfig) => {\n    const helper = { getAdapter, primaryAdapterId };\n    return new OneDate(dateConfig, helper);\n  };\n\n  const getCurrentDate = () => {\n    const date = primaryAdapter.l10n({\n      year: new Date().getFullYear(),\n      month: new Date().getMonth() + 1,\n      day: new Date().getDate(),\n    });\n    return generateDate(date);\n  };\n\n  const getMonthInfo = (year, month) => ({\n    name: primaryAdapter.getMonthName(month),\n    days: primaryAdapter.getMonthLength(year, month),\n  });\n\n  const getGenerator = (generatorId) => {\n    const generator = generators.find(g => g.id === generatorId);\n    if (!generator) throw new Error(`requested generator '${generatorId}' not found.`);\n    return generator;\n  };\n\n  const construct = () => {\n    const locale = config.locale || 'en';\n    adapters = ([GregorianAdapter]).concat((config.plugins || {}).adapters || []);\n    adapters = adapters.map(Adapter => new Adapter());\n    primaryAdapterId = config.primaryAdapterId || new GregorianAdapter({ locale }).id;\n    primaryAdapter = getAdapter(primaryAdapterId);\n\n    generators = ([BasicGenerator]).concat((config.plugins || {}).generators || []);\n    generators = generators.map((Generator) => {\n      const dependencies = { Event, OneDate, getAdapter, primaryAdapterId };\n      return new Generator(dependencies, { locale });\n    });\n  };\n  construct();\n\n  const addEvent = (eventConfig) => {\n    const generator = getGenerator(eventConfig.generatorId);\n    const event = generator.generate(eventConfig);\n    eventStore = eventStore.concat([event]);\n    return eventStore;\n  };\n\n  const removeEvent = (eventId) => {\n    eventStore = eventStore.filter(evt => evt.id !== eventId);\n    return eventStore;\n  };\n\n  const editEvent = (eventConfig) => {\n    removeEvent(eventConfig.id);\n    return addEvent(eventConfig);\n  };\n\n  const handleOverlaps = (seriesArray, _since, _till) => seriesArray.reduce((sArray, series) => {\n    if (series.overlap.external.includes('allow')) return sArray.concat([series]);\n\n    const conflicts = sArray.filter((s) => {\n      const sameGenerator = s.generatorId === series.generatorId;\n      const sameOverlapRule = s.overlap.external === series.overlap.external;\n      return sameGenerator && sameOverlapRule;\n    }).concat([series])\n      .sort((a, b) => b.range.since.int() - a.range.since.int());\n    if (conflicts.length === 1) return sArray.concat([series]);\n\n    const master = conflicts[0];\n\n    const items = sArray.filter((s) => {\n      const sameGenerator = s.generatorId === series.generatorId;\n      const sameOverlapRule = s.overlap.external === series.overlap.external;\n      return !(sameGenerator && sameOverlapRule);\n    });\n\n    const forever = series.overlap.external.includes('forever');\n\n    const rangeSince = master.range.since;\n    const rangeTill = forever ? _till.offsetYear(1) : master.range.till;\n\n    if (series.overlap.external.includes('remove')) {\n      const slaves = conflicts.slice(1).reduce((sa, s) => {\n        const item = s;\n        item.events = s.events\n          .filter(e => !e.collides(rangeSince, rangeTill));\n        return sa.concat(item);\n      }, []);\n      return items.concat([master]).concat(slaves);\n    }\n    if (series.overlap.external.includes('trim')) {\n      const slaves = conflicts.slice(1).reduce((sa, s) => {\n        const item = s;\n        const slaveEvents = s.events\n          .filter(e => e.collides(rangeSince, rangeTill))\n          .sort((a, b) => b.since.int() - a.since.int());\n        if (!slaveEvents.length) return sa.concat(item);\n        const evts = s.events\n          .filter(e => !e.collides(rangeSince, rangeTill));\n        const trimmedSlaves = slaveEvents.map((evt) => {\n          let slave = evt;\n          let collision = slave.collides(rangeSince, rangeTill);\n          while (collision) {\n            if (collision.includes('r')) {\n              slave = (new Event(Object.assign({}, slave, {\n                till: rangeSince.offsetDay(-1),\n              }))).query(_since, _till, 'event[]')[0];\n            } else if (collision.includes('l')) {\n              slave = (new Event(Object.assign({}, slave, {\n                since: rangeTill.offsetDay(1),\n              }))).query(_since, _till, 'event[]')[0];\n            }\n            collision = slave ? slave.collides(rangeSince, rangeTill) : false;\n          }\n          return slave;\n        }).filter(evt => evt && evt.till.int() - evt.since.int() >= 0);\n        item.events = evts.concat(trimmedSlaves);\n        return sa.concat(item);\n      }, []);\n      return items.concat([master]).concat(slaves);\n    }\n    return sArray.concat([series]);\n  }, []);\n\n  const getEventsIn = (_since, _till) => {\n    const since = generateDate(_since);\n    const till = generateDate(_till);\n    const seriesArray = eventStore.reduce((acc, e) => {\n      let sa = acc;\n      const series = e.query(since, till);\n      if (!series.events.length) return sa;\n      sa = sa.concat([series]);\n      sa = handleOverlaps(sa, since, till);\n      return sa;\n    }, []);\n    let events = seriesArray.reduce((evts, s) => evts.concat(s.events), []);\n    events = events.sort((a, b) => a.since.int() - b.since.int());\n    return events;\n  };\n\n  return {\n    getAdaptersInfo,\n    getGeneratorsInfo,\n    generateDate,\n    getCurrentDate,\n    getMonthInfo,\n    addEvent,\n    getEventsIn,\n    editEvent,\n    removeEvent,\n  };\n};\n\nexports.EventManager = EventManager;\n"]}